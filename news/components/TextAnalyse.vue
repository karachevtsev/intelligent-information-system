<template>
    <div class="text-analyse">
        <h3>–ê–Ω–∞–ª—ñ–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ —Ç–∞ –æ—Ç—Ä–∏–º—É–π—Ç–µ –¥–æ–¥–∞—Ç–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é!</h3>
        <p>–£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ –≤–∏ –º–∞—î—Ç–µ —á—É–¥–æ–≤—É –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª—ñ–∑ —Ç–µ–∫—Å—Ç—É —Å—Ç–∞—Ç—Ç—ñ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –ø–µ—Ä–µ–¥–æ–≤–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ —Ç–µ–∫—Å—Ç—É. –ü—Ä–æ—Å—Ç–æ
            –Ω–∞—Ç–∏—Å–∫–∞–π—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ —Ç–∞ –æ—Ç—Ä–∏–º—É–π—Ç–µ —Ü—ñ–Ω–Ω—ñ –≤–∏—Å–Ω–æ–≤–∫–∏ —Ç–∞ –¥–æ–¥–∞—Ç–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é</p>
        <b>–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ?</b>
        <ol>
            <li><b>–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö —Ç–µ–º —ñ –ø–æ–Ω—è—Ç—å.</b>
                –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—ñ –ø–æ–Ω—è—Ç—Ç—è —Ç–∞ —Ç–µ—Ä–º—ñ–Ω–∏ —Å—Ç–∞—Ç—Ç—ñ, —Ü–µ –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º —à–≤–∏–¥–∫–æ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏—Å—è –≤ —Å—É—Ç—ñ
                —Ç–µ–∫—Å—Ç—É —Ç–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –π–æ–≥–æ –æ—Å–Ω–æ–≤–Ω—ñ –∞—Å–ø–µ–∫—Ç–∏.
                –ó –ª–µ–≥–∫—ñ—Å—Ç—é –ø—Ä–æ–≤–æ–¥—å—Ç–µ –ø–æ—à–∫ –Ω–∞ –Ω–∞—à–æ–º—É —Ä–µ—Å—É—Ä—Å—ñ –ø–æ –∫–ª—é—á–æ–≤–∏—Ö —Å–ª–æ–≤–∞—Ö —Å—Ç–∞—Ç—Ç—ñ —Ç–∞ –æ—Ç—Ä–∏–º–∞–π—Ç–µ –≤–∏—Å–Ω–æ–≤–∫–∏.
            </li>
            <li><b>–û—Ü—ñ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ—é —Å—Ç–∞—Ç—Ç—ñ.</b>
                –î—ñ–∑–Ω–∞–π—Ç–µ—Å—è, —è–∫–∏–π –≤–ø–ª–∏–≤ –º–∞—î —Å—Ç–∞—Ç—Ç—è ‚Äî –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π —á–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∏–π, —â–æ –æ—Å–æ–±–ª–∏–≤–æ —î –≤–∞–∂–ª–∏–≤–∏–º –≤
                –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–∞. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–æ –ø—Ä–∏
                –ø—Ä–∏–π–Ω—è—Ç—Ç—ñ —Ä—ñ—à–µ–Ω—å —á–∏ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ –≤–∞—à–æ—ó –≤–ª–∞—Å–Ω–æ—ó –¥—É–º–∫–∏.
            </li>
        </ol>
        <p>–ù–∞—Ç–∏—Å–∫–∞–π—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ —Ç–∞ —Ä–æ–∑–ø–æ—á–∏–Ω–∞–π—Ç–µ –∞–Ω–∞–ª—ñ–∑ —Ç–µ–∫—Å—Ç—É! </p>
        <p class="text-center">
            <Spinner v-if="isAnalyzed"/>
            <button v-else class="btn" type="button" @click="analyzeText">–í–∏–∫–æ–Ω–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑ —Å—Ç–∞—Ç—Ç—ñ üìä</button>
        </p>
        <div class="text-analyse-result" v-if="sentimentAnalysisResult">
            <p>–û—Ü—ñ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ—é: {{ sentimentAnalysisResult }} {{ sentimentConfidenceScore * 100 }}%</p>
            <br>
            <p>–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞:</p>
            <ul v-if="keywords.length">
                <li v-for="keyword in keywords" :key="keyword">
                    <NuxtLink :to="`/search?query=${keyword}`" target="_blank">{{ keyword }}</NuxtLink>
                </li>
            </ul>
        </div>
    </div>
</template>

<script lang='ts' setup>
import { AzureKeyCredential, TextAnalyticsClient } from '@azure/ai-text-analytics';
import { ref } from 'vue';
import Spinner from 'dtkt-shared/components/Spinner.vue';

const props = defineProps<{
    text: string
}>();

const azureEndpoint = 'https://karachevtsev.cognitiveservices.azure.com';
const azureApiKey = '84f96db2785e4d14b8c960ba2b1c30b9';
const client = new TextAnalyticsClient(azureEndpoint, new AzureKeyCredential(azureApiKey));

interface ArticleRate {
    [key: string]: string;
}

const sentimentAnalysisResult = ref('');
const sentimentConfidenceScore = ref('');
const keywords = ref([]);

function removeTags(html: string) {
    return html.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim().substring(0, 5100);
}

const articleRate: ArticleRate = {
    positive: '–ü–æ–∑–∏—Ç–∏–≤–Ω–∏–π üü¢',
    negative: '–ù–µ–≥–∞—Ç–∏–≤–∏–Ω–∏–π üî¥',
    neutral: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π üü°',
    mixed: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π üü°',
};

const isAnalyzed = ref(false);
const analyzeText = async () => {
    isAnalyzed.value = true;
    const text = removeTags(props.text);

    const document = [
        { id: '1', language: 'uk', text: text },
    ];

    try {
        const [sentimentResult, keyPhrasesResult] = await Promise.all([
            client.analyzeSentiment(document),
            client.extractKeyPhrases(document),
        ]);
        sentimentAnalysisResult.value = articleRate[sentimentResult[0].sentiment];
        sentimentConfidenceScore.value = sentimentResult[0].confidenceScores[sentimentResult[0].sentiment];
        keywords.value = keyPhrasesResult[0].keyPhrases;
    } catch (error) {
        console.error('Error:', error);
    } finally {
        isAnalyzed.value = false;
    }
};
</script>

<style lang='scss'>
.text-analyse {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 30px;
    padding: 30px;
    background: #fff;
    border: 1px solid #EDEDEF;
    border-radius: 10px;

    h3 {
        text-align: center;
    }

    p {
        margin: 0;
    }

    ol {


        li + li {
            margin-top: 10px;
        }
    }
}

.text-analyse-result {


    ul {
        display: flex;
        flex-wrap: wrap;
        margin: 0;
        padding: 0;
        list-style: none;
        gap: 5px 10px;

        li {
        }
    }
}
</style>
